<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç¾åœ¨ã®ã‚«ãƒ©ãƒ€ã‚’å…¥åŠ›</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="app-wrapper">
    <h1>ç¾åœ¨ã®ã‚«ãƒ©ãƒ€ã‚’å…¥åŠ›</h1>

    <p id="preset-label"></p>

    <div class="form-group">
      <label class="form-label">
        èº«é•· (cm):
        <input id="height" type="number" />
      </label>
    </div>

    <div class="form-group">
      <label class="form-label">
        ä½“é‡ (kg):
        <input id="weight" type="number" />
      </label>
    </div>

    <div class="form-group">
      <label class="form-label">
        ä½“è„‚è‚ªç‡ (%):
        <input id="bodyFat" type="number" />
      </label>
    </div>

    <button id="calc-button" class="primary-button">ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—</button>

    <!-- BMI çµæœ -->
    <p id="result"></p>

    <!-- â˜… ç§°å·ï¼‹ã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="level-box" class="level-box">
      <div id="level-title" class="level-title"></div>
      <div class="level-bar">
        <div id="level-bar-inner" class="level-bar-inner"></div>
      </div>
      <p id="level-detail" class="level-detail"></p>
    </div>

    <!-- å‰å›ã®è¨˜éŒ² -->
    <div id="last-record" class="last-record-box"></div>
  </div>

      <!-- ã“ã‚Œã¾ã§ã®æ¨ç§»ã‚°ãƒ©ãƒ• -->
    <section class="history-section">
      <h2>ã“ã‚Œã¾ã§ã®æ¨ç§»</h2>
      <p class="history-note">
        è¨ˆç®—ã™ã‚‹ãŸã³ã«è¨˜éŒ²ã•ã‚Œã€ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«ã®æ¨ç§»ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚
      </p>
      <canvas id="historyChart"></canvas>
    </section>


  <script>
    // ===== å®šæ•° =====
      const STORAGE_KEY_LAST = "muscle_last_record_v1";
  const STORAGE_KEY_HISTORY = "muscle_history_v1";  // â˜…å±¥æ­´ç”¨

  let historyChart = null; // â˜…ã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜

  // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ preset ã‚’å–å¾—
  const params = new URLSearchParams(window.location.search);

    const presetId = params.get("preset") || "goku";

    const presetLabel = document.getElementById("preset-label");
    if (presetId === "goku") {
      presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: æ‚Ÿç©ºã‚¿ã‚¤ãƒ—";
    } else if (presetId === "athlete") {
      presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ã‚¹ãƒãƒ¼ãƒˆã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—";
    } else if (presetId === "bulk") {
      presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ãƒ‘ãƒ¯ãƒ¼ãƒªãƒ•ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—";
    } else if (presetId === "custom") {
      presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ã‚«ã‚¹ã‚¿ãƒ ï¼ˆè‡ªåˆ†ã§è¨­å®šï¼‰";
    } else {
      presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ä¸æ˜";
    }

    // ===== ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ç§°å·ã‚’æ±ºã‚ã‚‹é–¢æ•° =====
    function getRank(presetId, level) {
      if (presetId === "goku") {
        if (level < 20) {
          return {
            title: "ä¿®è¡Œä¸è¶³ã®åœ°çƒäºº",
            icon: "ğŸ˜´",
            message: "ä»Šæ—¥ã‹ã‚‰æœ¬æ°—å‡ºãã†ã€‚ã¾ãšã¯é€±2ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‹ã‚‰ï¼",
          };
        } else if (level < 40) {
          return {
            title: "ã‚«ãƒ¡ãƒã‚¦ã‚¹è¦‹ç¿’ã„",
            icon: "ğŸ¢",
            message: "åŸºç¤ã¯ã§ãã¦ããŸï¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸å¯§ã«æ„è­˜ã—ã‚ˆã†ã€‚",
          };
        } else if (level < 60) {
          return {
            title: "ç•Œç‹æ˜Ÿã§ä¿®è¡Œä¸­",
            icon: "ğŸª",
            message: "ã ã„ã¶ä»•ä¸ŠãŒã£ã¦ããŸã€‚é‡é‡ã‚’å°‘ã—æ”»ã‚ã¦ã‚‚OKï¼",
          };
        } else if (level < 80) {
          return {
            title: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº",
            icon: "ğŸ’¥",
            message: "ã‹ãªã‚Šã„ã„ã‚«ãƒ©ãƒ€ï¼å‘¨ã‚Šã‹ã‚‰ã‚‚å¤‰åŒ–ã«æ°—ã¥ã‹ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã€‚",
          };
        } else if (level < 95) {
          return {
            title: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº2",
            icon: "âš¡",
            message: "ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ä»•ä¸ŠãŒã‚Šã€‚é£Ÿäº‹ã¨ç¡çœ ã‚‚ãƒ—ãƒ­ä»•æ§˜ã§ã„ã“ã†ã€‚",
          };
        } else {
          return {
            title: "ä¼èª¬ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº3",
            icon: "ğŸŒŸ",
            message: "ã‚‚ã¯ã‚„ä¼èª¬ç´šã€‚ç¶­æŒã™ã‚‹ã“ã¨è‡ªä½“ãŒé«˜é›£åº¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼",
          };
        }
      }

      // ä»–ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã¨ã‚Šã‚ãˆãšå…±é€š
      if (level < 40) {
        return { title: "ãƒ«ãƒ¼ã‚­ãƒ¼", icon: "ğŸŒ±", message: "ã“ã“ã‹ã‚‰ä¸€æ°—ã«ä¼¸ã³ã‚‹ã‚¾ãƒ¼ãƒ³ï¼" };
      } else if (level < 70) {
        return { title: "ä¸­å …ã‚¢ã‚¹ãƒªãƒ¼ãƒˆ", icon: "ğŸƒ", message: "åœŸå°ã¯ãƒãƒƒãƒãƒªã€‚è³ªã‚’é«˜ã‚ã¦ã„ã“ã†ï¼" };
      } else {
        return { title: "ã‚¨ãƒªãƒ¼ãƒˆã‚¯ãƒ©ã‚¹", icon: "ğŸ†", message: "ã‹ãªã‚Šä»•ä¸ŠãŒã£ã¦ã‚‹ã€‚å¤§ä¼šã‚‚ç‹™ãˆã‚‹ãƒ¬ãƒ™ãƒ«ï¼" };
      }
    }

    // ===== å‰å›ã®è¨˜éŒ²ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° =====
    function showLastRecord(record) {
      const box = document.getElementById("last-record");
      if (!record) {
        box.textContent = "ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      const date = new Date(record.savedAt);
      const dateText = isNaN(date)
        ? ""
        : `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;

      let presetText = "";
      if (record.presetId === "goku") presetText = "æ‚Ÿç©ºã‚¿ã‚¤ãƒ—";
      else if (record.presetId === "athlete") presetText = "ã‚¹ãƒãƒ¼ãƒˆã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—";
      else if (record.presetId === "bulk") presetText = "ãƒ‘ãƒ¯ãƒ¼ãƒªãƒ•ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—";
      else if (record.presetId === "custom") presetText = "ã‚«ã‚¹ã‚¿ãƒ ";

      box.innerHTML = `
        <strong>å‰å›ã®è¨˜éŒ²</strong><br>
        ç›®æ¨™: ${presetText || "ä¸æ˜"}<br>
        BMI: ${record.bmi} / ãƒ¬ãƒ™ãƒ«: ${record.level}%<br>
        èº«é•·: ${record.height}cm  ä½“é‡: ${record.weight}kg  ä½“è„‚è‚ªç‡: ${record.fat}%<br>
        ${dateText ? `è¨˜éŒ²æ—¥: ${dateText}` : ""}
      `;
    }

        // ===== å±¥æ­´ã‹ã‚‰ã‚°ãƒ©ãƒ•ã‚’æç”» =====
    function updateHistoryChart(allRecords) {
      // ä»Šã® preset ã®å±¥æ­´ã ã‘ã«çµã‚‹
      const records = allRecords.filter(r => r.presetId === presetId);

      if (records.length === 0) {
        // å±¥æ­´ãŒãªã‘ã‚Œã°ã‚°ãƒ©ãƒ•ã¯æ¶ˆã™ï¼ä½•ã‚‚ã—ãªã„
        if (historyChart) {
          historyChart.destroy();
          historyChart = null;
        }
        return;
      }

      const labels = records.map((r, i) => {
        const d = new Date(r.savedAt);
        if (isNaN(d)) return `#${i + 1}`;
        return `${d.getMonth() + 1}/${d.getDate()}`;
      });

      const levels = records.map(r => r.level);

      const ctx = document.getElementById("historyChart").getContext("2d");

      if (historyChart) {
        historyChart.destroy();
      }

      historyChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«ï¼ˆ%ï¼‰",
              data: levels,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 3,
            },
          ],
        },
        options: {
          scales: {
            y: {
              min: 0,
              max: 100,
              ticks: {
                stepSize: 20,
              },
            },
          },
        },
      });
    }


    // ===== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šlocalStorage ã‹ã‚‰å¾©å…ƒ =====
       (function loadOnStart() {
      try {
        // æœ€æ–°è¨˜éŒ²
        const rawLast = localStorage.getItem(STORAGE_KEY_LAST);
        let record = null;

        if (rawLast) {
          record = JSON.parse(rawLast);

          // ä»Šã® preset ã¨ä¸€è‡´ã—ã¦ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚‚åŸ‹ã‚ã‚‹
          if (record.presetId === presetId) {
            document.getElementById("height").value = record.height ?? "";
            document.getElementById("weight").value = record.weight ?? "";
            document.getElementById("bodyFat").value = record.fat ?? "";
          }

          // å‰å›ã®è¨˜éŒ²è¡¨ç¤º
          showLastRecord(record);

          // ç§°å·ï¼‹ã‚²ãƒ¼ã‚¸å¾©å…ƒ
          if (record.level != null) {
            const rank = getRank(record.presetId, record.level);
            const titleEl = document.getElementById("level-title");
            const detailEl = document.getElementById("level-detail");
            const barInner = document.getElementById("level-bar-inner");

            titleEl.textContent = `${rank.icon} ${rank.title}ï¼ˆ${record.level}%ï¼‰`;
            detailEl.textContent = rank.message;
            barInner.style.width = `${record.level}%`;
          }
        } else {
          showLastRecord(null);
        }

        // å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚°ãƒ©ãƒ•æ›´æ–°
        const rawHist = localStorage.getItem(STORAGE_KEY_HISTORY);
        const historyList = rawHist ? JSON.parse(rawHist) : [];
        updateHistoryChart(historyList);

      } catch (e) {
        console.error("èµ·å‹•æ™‚ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
        showLastRecord(null);
      }
    })();


    // ===== è¨ˆç®—ãƒœã‚¿ãƒ³ =====
    document.getElementById("calc-button").addEventListener("click", async () => {
      const h = Number(document.getElementById("height").value);
      const w = Number(document.getElementById("weight").value);
      const f = Number(document.getElementById("bodyFat").value);

      if (!h || !w) {
        alert("èº«é•·ã¨ä½“é‡ã¯å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è¨ˆç®—ä¾é ¼
      const res = await fetch("/calc_level", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          height: h,
          weight: w,
          fat: f,
          preset_id: presetId,
        }),
      });

      const data = await res.json();

      // BMI è¡¨ç¤º
      document.getElementById("result").textContent =
        `ã‚ãªãŸã®ç¾åœ¨ã®BMIã¯ ${data.bmi} ã§ã™ï¼ˆä½“è„‚è‚ªç‡: ${f}%ï¼‰ã€‚`;

      // â˜… ç§°å·ï¼‹ã‚²ãƒ¼ã‚¸è¡¨ç¤º
      if (data.level != null) {
        const rank = getRank(presetId, data.level);
        const titleEl = document.getElementById("level-title");
        const detailEl = document.getElementById("level-detail");
        const barInner = document.getElementById("level-bar-inner");

        titleEl.textContent = `${rank.icon} ${rank.title}ï¼ˆ${data.level}%ï¼‰`;
        detailEl.textContent = rank.message;
        barInner.style.width = `${data.level}%`;
      }

            // è¨˜éŒ²ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      const record = {
        presetId: presetId,
        height: h,
        weight: w,
        fat: f,
        bmi: data.bmi,
        level: data.level,
        savedAt: new Date().toISOString(),
      };

      // æœ€æ–°è¨˜éŒ²ã¨ã—ã¦ä¿å­˜
      try {
        localStorage.setItem(STORAGE_KEY_LAST, JSON.stringify(record));
        showLastRecord(record);
      } catch (e) {
        console.error("æœ€æ–°è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
      }

      // å±¥æ­´ã¨ã—ã¦è¿½åŠ 
      try {
        const rawHist = localStorage.getItem(STORAGE_KEY_HISTORY);
        const historyList = rawHist ? JSON.parse(rawHist) : [];

        historyList.push(record);

        // ç›´è¿‘50ä»¶ã ã‘æ®‹ã™ãªã©ï¼ˆå¤šã™ãé˜²æ­¢ï¼‰
        const trimmed = historyList.slice(-50);

        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(trimmed));
        updateHistoryChart(trimmed);
      } catch (e) {
        console.error("å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
      }

    });
  </script>
</body>
</html>

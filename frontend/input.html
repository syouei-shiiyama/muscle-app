<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç¾åœ¨ã®ã‚«ãƒ©ãƒ€ã‚’å…¥åŠ›</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="app-wrapper">
    <h1>ç¾åœ¨ã®ã‚«ãƒ©ãƒ€ã‚’å…¥åŠ›</h1>

    <p id="preset-label"></p>

    <div class="form-group">
      <label class="form-label">
        èº«é•· (cm):
        <input id="height" type="number" />
      </label>
    </div>

    <div class="form-group">
      <label class="form-label">
        ä½“é‡ (kg):
        <input id="weight" type="number" />
      </label>
    </div>

    <div class="form-group">
      <label class="form-label">
        ä½“è„‚è‚ªç‡ (%):
        <input id="bodyFat" type="number" />
      </label>
    </div>

    <button id="calc-button" class="primary-button">ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—</button>

    <!-- BMI çµæœ -->
    <p id="result"></p>

    <!-- ç§°å·ï¼‹ã‚²ãƒ¼ã‚¸ -->
    <div id="level-box" class="level-box">
      <div id="level-title" class="level-title"></div>
      <div class="level-bar">
        <div id="level-bar-inner" class="level-bar-inner"></div>
      </div>
      <p id="level-detail" class="level-detail"></p>
    </div>

    <!-- å‰å›ã®è¨˜éŒ² -->
    <div id="last-record" class="last-record-box"></div>
  </div>

  <!-- ã“ã‚Œã¾ã§ã®æ¨ç§»ã‚°ãƒ©ãƒ• -->
  <section class="history-section">
    <h2>ã“ã‚Œã¾ã§ã®æ¨ç§»</h2>
    <p class="history-note">
      ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦è¨ˆç®—ã™ã‚‹ãŸã³ã«è¨˜éŒ²ã•ã‚Œã€ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«ã®æ¨ç§»ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚
    </p>
    <canvas id="historyChart"></canvas>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ====== å…±é€šå¤‰æ•° ======
      const token = localStorage.getItem("access_token"); // login.html ã§ä¿å­˜æ¸ˆã¿
      const params = new URLSearchParams(window.location.search);
      const presetId = params.get("preset") || "goku";

      const presetLabel = document.getElementById("preset-label");
      const lastRecordBox = document.getElementById("last-record");
      const historySection = document.querySelector(".history-section");

      let historyChart = null;

      // ====== ãƒ—ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º ======
      if (presetId === "goku") {
        presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: æ‚Ÿç©ºã‚¿ã‚¤ãƒ—";
      } else if (presetId === "athlete") {
        presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ã‚¹ãƒãƒ¼ãƒˆã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—";
      } else if (presetId === "bulk") {
        presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ãƒ‘ãƒ¯ãƒ¼ãƒªãƒ•ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—";
      } else if (presetId === "custom") {
        presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ã‚«ã‚¹ã‚¿ãƒ ï¼ˆè‡ªåˆ†ã§è¨­å®šï¼‰";
      } else {
        presetLabel.textContent = "é¸æŠä¸­ã®ç›®æ¨™: ä¸æ˜";
      }

      // ====== ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ç§°å·ã‚’æ±ºã‚ã‚‹é–¢æ•° ======
      function getRank(presetId, level) {
        if (presetId === "goku") {
          if (level < 20) {
            return {
              title: "ä¿®è¡Œä¸è¶³ã®åœ°çƒäºº",
              icon: "ğŸ˜´",
              message: "ä»Šæ—¥ã‹ã‚‰æœ¬æ°—å‡ºãã†ã€‚ã¾ãšã¯é€±2ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‹ã‚‰ï¼",
            };
          } else if (level < 40) {
            return {
              title: "ã‚«ãƒ¡ãƒã‚¦ã‚¹è¦‹ç¿’ã„",
              icon: "ğŸ¢",
              message: "åŸºç¤ã¯ã§ãã¦ããŸï¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸å¯§ã«æ„è­˜ã—ã‚ˆã†ã€‚",
            };
          } else if (level < 60) {
            return {
              title: "ç•Œç‹æ˜Ÿã§ä¿®è¡Œä¸­",
              icon: "ğŸª",
              message: "ã ã„ã¶ä»•ä¸ŠãŒã£ã¦ããŸã€‚é‡é‡ã‚’å°‘ã—æ”»ã‚ã¦ã‚‚OKï¼",
            };
          } else if (level < 80) {
            return {
              title: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº",
              icon: "ğŸ’¥",
              message: "ã‹ãªã‚Šã„ã„ã‚«ãƒ©ãƒ€ï¼å‘¨ã‚Šã‹ã‚‰ã‚‚å¤‰åŒ–ã«æ°—ã¥ã‹ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã€‚",
            };
          } else if (level < 95) {
            return {
              title: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº2",
              icon: "âš¡",
              message: "ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ä»•ä¸ŠãŒã‚Šã€‚é£Ÿäº‹ã¨ç¡çœ ã‚‚ãƒ—ãƒ­ä»•æ§˜ã§ã„ã“ã†ã€‚",
            };
          } else {
            return {
              title: "ä¼èª¬ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µã‚¤ãƒ¤äºº3",
              icon: "ğŸŒŸ",
              message: "ã‚‚ã¯ã‚„ä¼èª¬ç´šã€‚ç¶­æŒã™ã‚‹ã“ã¨è‡ªä½“ãŒé«˜é›£åº¦ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼",
            };
          }
        }

        // ä»–ãƒ—ãƒªã‚»ãƒƒãƒˆã¯å…±é€š
        if (level < 40) {
          return { title: "ãƒ«ãƒ¼ã‚­ãƒ¼", icon: "ğŸŒ±", message: "ã“ã“ã‹ã‚‰ä¸€æ°—ã«ä¼¸ã³ã‚‹ã‚¾ãƒ¼ãƒ³ï¼" };
        } else if (level < 70) {
          return { title: "ä¸­å …ã‚¢ã‚¹ãƒªãƒ¼ãƒˆ", icon: "ğŸƒ", message: "åœŸå°ã¯ãƒãƒƒãƒãƒªã€‚è³ªã‚’é«˜ã‚ã¦ã„ã“ã†ï¼" };
        } else {
          return { title: "ã‚¨ãƒªãƒ¼ãƒˆã‚¯ãƒ©ã‚¹", icon: "ğŸ†", message: "ã‹ãªã‚Šä»•ä¸ŠãŒã£ã¦ã‚‹ã€‚å¤§ä¼šã‚‚ç‹™ãˆã‚‹ãƒ¬ãƒ™ãƒ«ï¼" };
        }
      }

      // ====== å‰å›ã®è¨˜éŒ²è¡¨ç¤ºï¼ˆã‚µãƒ¼ãƒãƒ¼ã® Measurement ã‹ã‚‰ï¼‰ ======
      function showLastRecordFromServer(record) {
        if (!record) {
          lastRecordBox.textContent = "ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }

        const d = new Date(record.created_at);
        const dateText = isNaN(d)
          ? ""
          : `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;

        let presetText = "";
        if (record.preset_id === "goku") presetText = "æ‚Ÿç©ºã‚¿ã‚¤ãƒ—";
        else if (record.preset_id === "athlete") presetText = "ã‚¹ãƒãƒ¼ãƒˆã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—";
        else if (record.preset_id === "bulk") presetText = "ãƒ‘ãƒ¯ãƒ¼ãƒªãƒ•ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—";
        else if (record.preset_id === "custom") presetText = "ã‚«ã‚¹ã‚¿ãƒ ";

        // BMI ã‚’è¨ˆç®—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¿å­˜ã—ã¦ãªã„ã®ã§ã“ã“ã§è¨ˆç®—ï¼‰
        const bmi = record.height
          ? Math.round((record.weight / Math.pow(record.height / 100, 2)) * 10) / 10
          : null;

        lastRecordBox.innerHTML = `
          <strong>å‰å›ã®è¨˜éŒ²</strong><br>
          ç›®æ¨™: ${presetText || "ä¸æ˜"}<br>
          ${bmi !== null ? `BMI: ${bmi} / ` : ""}ãƒ¬ãƒ™ãƒ«: ${record.level}%<br>
          èº«é•·: ${record.height}cm  ä½“é‡: ${record.weight}kg  ä½“è„‚è‚ªç‡: ${record.fat}%<br>
          ${dateText ? `è¨˜éŒ²æ—¥: ${dateText}` : ""}
        `;
      }

      // ====== ã‚°ãƒ©ãƒ•æç”»ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒªã‚¹ãƒˆï¼‰ ======
      function updateHistoryChartFromServer(records) {
        // ä»Šã® preset ã®å±¥æ­´ã ã‘
        const filtered = records.filter(r => r.preset_id === presetId);

        if (filtered.length === 0) {
          if (historyChart) {
            historyChart.destroy();
            historyChart = null;
          }
          return;
        }

        const labels = filtered.map((r, i) => {
          const d = new Date(r.created_at);
          if (isNaN(d)) return `#${i + 1}`;
          return `${d.getMonth() + 1}/${d.getDate()}`;
        });

        const levels = filtered.map(r => r.level);

        const ctx = document.getElementById("historyChart").getContext("2d");

        if (historyChart) {
          historyChart.destroy();
        }

        historyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "ç›®æ¨™é”æˆãƒ¬ãƒ™ãƒ«ï¼ˆ%ï¼‰",
                data: levels,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
              },
            ],
          },
          options: {
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: { stepSize: 20 },
              },
            },
          },
        });
      }

      // ====== ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ ======
      async function loadHistoryFromServer() {
        if (!token) {
          // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚
          lastRecordBox.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è¨˜éŒ²ã®å±¥æ­´ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚";
          if (historySection) historySection.style.display = "none";
          return;
        }

        try {
          const res = await fetch("/records", {
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          if (!res.ok) {
            console.error("GET /records error", res.status);
            lastRecordBox.textContent = "è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            if (historySection) historySection.style.display = "none";
            return;
          }

          const list = await res.json(); // List[RecordOut]

          if (list.length === 0) {
            showLastRecordFromServer(null);
            updateHistoryChartFromServer([]);
            return;
          }

          const last = list[list.length - 1];
          showLastRecordFromServer(last);
          updateHistoryChartFromServer(list);
        } catch (e) {
          console.error("loadHistoryFromServer error", e);
          lastRecordBox.textContent = "è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          if (historySection) historySection.style.display = "none";
        }
      }

      // ====== èµ·å‹•æ™‚ï¼šå±¥æ­´èª­ã¿è¾¼ã¿ ======
      loadHistoryFromServer();

      // ====== è¨ˆç®—ãƒœã‚¿ãƒ³ ======
      document.getElementById("calc-button").addEventListener("click", async () => {
        const h = Number(document.getElementById("height").value);
        const w = Number(document.getElementById("weight").value);
        const f = Number(document.getElementById("bodyFat").value);

        if (!h || !w) {
          alert("èº«é•·ã¨ä½“é‡ã¯å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        let data;
        try {
          const res = await fetch("/calc_level", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              height: h,
              weight: w,
              fat: f,
              preset_id: presetId,
            }),
          });

          data = await res.json();

          if (!res.ok || data.error) {
            alert(data.error || "ãƒ¬ãƒ™ãƒ«è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            return;
          }
        } catch (e) {
          console.error(e);
          alert("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          return;
        }

        // BMI è¡¨ç¤º
        document.getElementById("result").textContent =
          `ã‚ãªãŸã®ç¾åœ¨ã®BMIã¯ ${data.bmi} ã§ã™ï¼ˆä½“è„‚è‚ªç‡: ${f}%ï¼‰ã€‚`;

        // ç§°å·ï¼‹ã‚²ãƒ¼ã‚¸
        if (data.level != null) {
          const rank = getRank(presetId, data.level);
          const titleEl = document.getElementById("level-title");
          const detailEl = document.getElementById("level-detail");
          const barInner = document.getElementById("level-bar-inner");

          titleEl.textContent = `${rank.icon} ${rank.title}ï¼ˆ${data.level}%ï¼‰`;
          detailEl.textContent = rank.message;
          barInner.style.width = `${data.level}%`;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ã‚µãƒ¼ãƒãƒ¼ã«è¨˜éŒ²ã‚’ä¿å­˜
        if (!token) {
          // ã‚²ã‚¹ãƒˆã¯ä¿å­˜ã›ãšçµ‚äº†ï¼ˆãã®å ´ã®è¨ˆç®—ã ã‘ï¼‰
          return;
        }

        try {
          const res2 = await fetch("/records", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              preset_id: presetId,
              height: h,
              weight: w,
              fat: f,
              level: data.level,
            }),
          });

          if (!res2.ok) {
            const err = await res2.json().catch(() => ({}));
            console.error("POST /records error", res2.status, err);
            alert("ã‚µãƒ¼ãƒãƒ¼ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.detail || res2.status));
          } else {
            console.log("Record saved to server");
            // ä¿å­˜ãŒæˆåŠŸã—ãŸã‚‰ã€å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
            loadHistoryFromServer();
          }
        } catch (e) {
          console.error("save record error", e);
          alert("ã‚µãƒ¼ãƒãƒ¼ã¸ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
      });
    });
  </script>
</body>
</html>
